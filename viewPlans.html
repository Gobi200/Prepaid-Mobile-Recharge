<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrePaid Mobile Recharge</title>
    <!-- Bootstrap Css -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- CSS FILE -->
    <link rel="stylesheet" type="text/css" href="home.css">
    <link rel="stylesheet" type="text/css" href="viewPlans.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Agbalumo&display=swap" rel="stylesheet">

    <style>
        .category-container {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 10px;
            /* margin-left: 10px; */
        }
        #category-container {
            overflow-x: auto;
            -ms-overflow-style: none;  /* Hide scrollbar for Internet Explorer & Edge */
            scrollbar-width: none;      /* Hide scrollbar for Firefox */
            cursor: grab;
        }

        /* Hide scrollbar for Chrome, Safari, and Edge */
        #category-container::-webkit-scrollbar {
            display: none;
        }
        .nav-item {
            cursor: pointer;
            transition: 0.3s;
            border-radius: 5px;
            white-space: nowrap; /* Prevents text from wrapping */
        }

        .nav-item.active {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
        }

        .nav-item.active .nav-links {
            color: white !important;
        }

        .nav-links {
            font-size: 1rem;
            color: black;
            text-decoration: none;
            display: block;
        }

        .plan-card {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px;
            text-align: center;
        }

        .plan-card h3 {
            margin-bottom: 10px;
        }

        .plan-card button {
            background-color: white;
            color: #2575fc;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        .ott-icon {
            width: 40px; /* Adjust size */
            height: auto;
            vertical-align: middle;
        }  
    </style>
</head>
<body>

    <!-- NAVIGATION BAR -->
    <div class="header">
        <nav class="navbar navbar-expand-md fixed-top custom-navbar">
            <div class="container-fluid">
                <!-- Navbar Brand (Left) -->
                <a class="navbar-brand logo" href="Home.html">
                    <span class="logo_first_letter">M</span><span class="sub_logo">obiComm</span>
                </a>
    
                <!-- Navbar Links (Visible on Medium and Larger Screens) -->
                <div class="d-none d-md-flex justify-content-center flex-grow-1">
                    <div class="navbar-nav">
                        <a class="nav-link nav_font" href="Home.html">Home</a>
                        <a class="nav-link nav_font" href="about.html">About</a>
                        <a class="nav-link active nav_font fw-bold" href="viewPlans.html">View Plans</a>
                        <a class="nav-link nav_font" href="contact.html">Contact</a>
                    </div>
                </div>
    
                <!-- User Icon & Offcanvas Toggle (Right Side) -->
                <div class="d-flex align-items-center">
                    <!-- User Icon -->
                    <a href="userLogin.html" class="me-3"><i class="bi bi-person-circle header_icon_color fs-4"></i></a>
    
                    <!-- Offcanvas Toggle Button (Visible on Mobile & Tablets) -->
                    <button class="btn btn-outline-secondary d-md-none border-0" type="button" data-bs-toggle="offcanvas"
                        data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar">
                        <i class="bi bi-list fs-3"></i>
                    </button>
                </div>
            </div>
        </nav>
    
        <!-- Offcanvas Navigation (Only for Mobile & Tablet Screens) -->
        <div class="offcanvas offcanvas-end d-md-none custom-offcanvas" tabindex="-1" id="offcanvasNavbar"
            aria-labelledby="offcanvasNavbarLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="offcanvasNavbarLabel">Menu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <div class="navbar-nav">
                    <a class="nav-link nav_font" href="Home.html">Home</a>
                    <a class="nav-link nav_font" href="about.html">About</a>
                    <a class="nav-link active nav_font fw-bold" href="viewPlans.html">View Plans</a>
                    <a class="nav-link nav_font" href="contact.html">Contact</a>
                </div>
            </div>
        </div>
    </div>


    <div class="container">
        <div class="row d-flex justify-content-center">
            <!-- Categories Navigation -->
            <div class="col-12 shadow">
                <div class="category-container text-center">
                    <h4 class="text-center fw-bold mb-3">PLAN CATEGORY</h4>
                    <div class="d-flex overflow-auto flex-nowrap" id="category-container"></div>
                </div>
            </div>

            <!-- Plans Display -->
            <div class="col-lg-12 col-md-12 mt-3">
                <h2 id="selected-category-name" class="mt-3 mb-4 text-center"></h2>
                <div id="plans-container" class="row"></div>
            </div>
        </div>
    </div>

    <!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="filterModalLabel">Filter Plans</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="filterForm">
            <!-- Price Range -->
            <div class="mb-3">
              <label for="priceRange" class="form-label">Price Range</label>
              <input type="range" class="form-range" id="priceRange" min="0" max="1000" step="10">
              <span id="priceValue">0 - 1000</span>
            </div>
            <!-- Validity -->
            <div class="mb-3">
              <label for="validitySelect" class="form-label">Validity</label>
              <select class="form-select" id="validitySelect">
                <option value="">All</option>
                <option value="1 day">1 Day</option>
                <option value="7 days">7 Days</option>
                <option value="28 days">28 Days</option>
                <option value="90 days">90 Days</option>
              </select>
            </div>
            <!-- Data -->
            <div class="mb-3">
              <label for="dataSelect" class="form-label">Data</label>
              <select class="form-select" id="dataSelect">
                <option value="">All</option>
                <option value="1GB">1GB</option>
                <option value="2GB">2GB</option>
                <option value="3GB">3GB</option>
                <option value="Unlimited">Unlimited</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
        </div>
      </div>
    </div>
  </div>
    <script>
        // Fetch categories from backend
        async function fetchCategories() {
            try {
                const response = await fetch("http://localhost:8091/category");
                const categories = await response.json();

                // Filter only ACTIVE categories
                const activeCategories = categories.filter(category => category.status === "ACTIVE");
                
                displayCategories(activeCategories);

                // Set the initial active category and fetch its plans
                if (activeCategories.length > 0) {
                    let firstCategory = document.querySelector(".nav-item");
                    setActiveCategory(firstCategory, activeCategories[0].categoryId);
                }
                
            } catch (error) {
                console.error("Error fetching categories:", error);
            }
        }

        // Display categories with horizontal scroll
        function displayCategories(categories) {
            let categoryContainer = document.getElementById("category-container");
            categoryContainer.innerHTML = "";

            if (categories.length === 0) {
                categoryContainer.innerHTML = "<p>No active categories available.</p>";
                return;
            }

            categories.forEach((category, index) => {
                let activeClass = index === 0 ? "active" : "";
                let listItem = document.createElement("div");
                listItem.className = `nav-item ${activeClass} mx-2 px-3 border rounded`;
                listItem.innerHTML = `<a class="nav-link nav-links">${category.categoryName}</a>`;
                listItem.onclick = () => setActiveCategory(listItem, category.categoryId);
                categoryContainer.appendChild(listItem);
            });

            // Load first active category's plans by default
            if (categories.length > 0) {
                fetchPlans(categories[0].categoryId);
            }
        }

        // Set active category and fetch plans
        function setActiveCategory(selectedItem, categoryId) {
    // Remove active class from all categories
    document.querySelectorAll(".nav-item").forEach(item => item.classList.remove("active"));

    // Add active class to the clicked category
    selectedItem.classList.add("active");

    // Scroll into view smoothly
    selectedItem.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "center" });

    // Update the category name in the heading
    let categoryName = selectedItem.querySelector(".nav-links").innerText;
    document.getElementById("selected-category-name").innerText = categoryName;

    // Fetch plans for the selected category
    fetchPlans(categoryId);
}



        // Fetch plans based on selected category
        async function fetchPlans(categoryId) {
            try {
                const response = await fetch(`http://localhost:8091/plans/category/${categoryId}`);
                const plans = await response.json();
                displayPlans(plans);
            } catch (error) {
                console.error("Error fetching plans:", error);
            }
        }

        // Display plans dynamically
        function displayPlans(plans) {
    let plansContainer = document.getElementById("plans-container");
    plansContainer.innerHTML = "";

    if (plans.length === 0) {
        plansContainer.innerHTML = "<p>No plans available for this category.</p>";
        return;
    }

    plans.forEach(plan => {
        // Count number of OTT subscriptions
        let ottCount = plan.ottPlans && plan.ottPlans.length > 0 ? plan.ottPlans.length : 0;
        let ottDisplay = ottCount > 0 ? `<span class="fs-6">${ottCount} OTT's</span>` : "";

        // Generate OTT subscription icons
        let subscriptionIcons = plan.ottPlans && plan.ottPlans.length > 0
            ? plan.ottPlans.map(ott => `<img src="Assert/PlanImages/${ott.icons}.png" alt="${ott.platformName}" class="ott-icon ms-3">`).join("")
            : "No OTT benefits";

        let planCard = `
            <div class="col-md-4 mb-3">
                <div class="card plan_card">
                    <div class="card-header text-white fs-4 text-start d-inline-block plan_card_head">
                        <span class="plan_price fw-bold fs-1 d-inline-block">â‚¹${plan.planPrice}</span>
                        <br>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="d-block plan_span p-1">${plan.validity} <span class="h5"> | </span> ${plan.data}</span>
                            ${ottDisplay}
                        </div>
                        <span class="popular-tag position-absolute top-0 end-0 my-3 px-3 py-1 fw-bold tag">
                            ${plan.tag ? plan.tag : ""}
                        </span>
                    </div>
                    <div class="card-body plan_card_body">
                        <p><i class="bi bi-telephone-fill icon_color_call pe-2"></i> ${plan.voice}</p>
                        <p><i class="bi bi-reception-4 icon_color_call pe-2"></i>${plan.data}</p>
                        <p><i class="bi bi-alarm-fill icon_color pe-2"></i> Validity: ${plan.validity}</p>
                        <p><i class="bi bi-chat-dots-fill icon_color pe-2"></i> ${plan.message}</p>
                        <p><i class="bi bi-bell-fill icon_color pe-2"></i> Subscription:</p>
                        <p>${subscriptionIcons}</p>
                        <p><i class="bi bi-patch-check-fill icon_color pe-2"></i> Benefits:</p>
                        <ul>
                            <li>${plan.description ? plan.description.replace(/'/g, "\\'") : "No extra benefits"}</li>
                        </ul>
                    </div>
                    <div class="card-footer p-3">
                        <button class="buy_button" onclick="redirectToPurchase(${plan.planPrice}, 
                        '${plan.validity}', 
                        '${plan.data}', 
                        '${plan.voice}', 
                        '${plan.message}', 
                        '${plan.subscriptions ? plan.subscriptions.join(', ') : ''}', 
                        '${plan.description ? plan.description.replace(/'/g, "\\'") : ''}')"> Get Plan </button>
                    </div>
                </div>
            </div>
        `;

        plansContainer.innerHTML += planCard;
    });
}


        // Fetch categories when page loads
        fetchCategories();

        function redirectToPurchase(planPrice, validity, data, voice, message, subscriptions, description) {
    let button = event.target;

    // Apply loader animation styles
    button.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...`;
    button.style.color = "#023E8A";
    button.style.backgroundColor = "#ffffff";
    button.style.border = "1px solid #023E8A";
    button.disabled = true;

    // Ensure subscriptions are properly formatted (if it's an array, encode each item)
    if (Array.isArray(subscriptions)) {
        subscriptions = subscriptions.map(encodeURIComponent).join(',');
    } else {
        subscriptions = encodeURIComponent(subscriptions || '');
    }

    // Ensure description is properly encoded
    description = encodeURIComponent(description || '');

    // Wait for 1.5 seconds before redirecting
    setTimeout(() => {
        let queryParams = `?price=${planPrice}&validity=${validity}&data=${data}&voice=${voice}&message=${message}&subscriptions=${subscriptions}&description=${description}`;
        window.location.href = "payment.html" + queryParams;
    }, 1500);
}


        
    </script>

</body>
</html>

